<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light only">
    <meta name="theme-color" content="#ffffff">
    <title>Panel de Control de Precios</title>
    <!-- Añadir fuente Roboto de Google -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <!-- Estilos inline para forzar tema claro -->
    <style>
      html, body {
        background-color: #ffffff !important;
        color: #000000 !important;
        margin: 0;
        padding: 0;
        font-family: 'Roboto', Arial, sans-serif;
      }
      #root {
        background-color: #ffffff !important;
        min-height: 100vh;
        width: 100%;
      }
      /* Estilo de fallback si React no carga */
      #fallback {
        display: none;
        text-align: center;
        padding: 2rem;
        max-width: 800px;
        margin: 0 auto;
      }
      /* Mostrar el fallback después de 3 segundos si la app no carga */
      @media (prefers-color-scheme: dark) {
        html, body, #root {
          background-color: #ffffff !important;
          color: #000000 !important;
        }
      }
    </style>
    <!-- Script para mostrar contenido de fallback si React no carga en 3 segundos -->
    <script>
      // Mostrar fallback después de 3 segundos si React no ha cargado
      setTimeout(function() {
        const root = document.getElementById('root');
        const fallback = document.getElementById('fallback');
        if (root && (!root.childNodes.length || root.childNodes.length === 0)) {
          console.log('React no ha renderizado después de 3 segundos, mostrando fallback');
          if (fallback) {
            fallback.style.display = 'block';
          }
        }
      }, 3000);
    </script>
  </head>
  <body>
    <div id="root"></div>
    <!-- Contenido de fallback que se mostrará si React no carga -->
    <div id="fallback">
      <h1>Cargando aplicación...</h1>
      <p>Si esta pantalla persiste, puede haber un problema técnico.</p>
      <div id="currency-loading" style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
        <p style="margin: 0 0 10px 0;">Cargando tasas de cambio...</p>
        <div id="currency-status" style="font-size: 14px; color: #666;"></div>
      </div>
      <button onclick="window.location.reload()" style="padding: 8px 16px; background-color: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px;">
        Recargar página
      </button>
      <div style="margin-top: 30px; text-align: left; padding: 20px; background-color: #f5f5f5; border-radius: 8px;">
        <h3>Solución de problemas:</h3>
        <ol>
          <li>Verifique su conexión a internet</li>
          <li>Intente borrar la caché de su navegador</li>
          <li>Si usa bloqueadores de anuncios, desactívelos para este sitio</li>
          <li>Use Chrome o Firefox para una mejor experiencia</li>
        </ol>
      </div>
    </div>
    <script type="module" src="/src/main.tsx"></script>
    <script>
      // Función para cargar las tasas de cambio
      async function loadCurrencyRates() {
        const currencyStatus = document.getElementById('currency-status');
        const minDelay = 1000; // Retraso mínimo de 1 segundo en milisegundos
        const startTime = Date.now();

        try {
          const response = await fetch('https://mcs-erp-backend-807184488368.southamerica-west1.run.app/api/products/cache/all');
          const data = await response.json();
          
          const endTime = Date.now();
          const elapsedTime = endTime - startTime;
          const remainingDelay = Math.max(0, minDelay - elapsedTime);

          // Esperar el tiempo restante si es necesario
          await new Promise(resolve => setTimeout(resolve, remainingDelay));

          if (data.success && data.data.currencies) {
            const { dollar, euro } = data.data.currencies;
            const lastUpdate = new Date(dollar.last_update).toLocaleString();
            
            currencyStatus.innerHTML = `
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>USD/CLP:</span>
                <span>${dollar.value?.toLocaleString() || 'N/A'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>EUR/CLP:</span>
                <span>${euro.value?.toLocaleString() || 'N/A'}</span>
              </div>
              <div style="font-size: 12px; color: #888; margin-top: 10px;">
                Última actualización: ${lastUpdate}
              </div>
            `;
          } else {
            throw new Error('Formato de respuesta inválido');
          }
        } catch (error) {
           const endTime = Date.now();
           const elapsedTime = endTime - startTime;
           const remainingDelay = Math.max(0, minDelay - elapsedTime);

           // Esperar el tiempo restante si hay un error también
           await new Promise(resolve => setTimeout(resolve, remainingDelay));

          currencyStatus.innerHTML = `
            <div style="color: #dc2626; font-size: 14px;">
              Error al cargar las tasas de cambio. Por favor, intente nuevamente.
            </div>
          `;
        }
      }

      // Cargar las tasas de cambio cuando se muestre el fallback
      setTimeout(function() {
        const root = document.getElementById('root');
        const fallback = document.getElementById('fallback');
        if (root && (!root.childNodes.length || root.childNodes.length === 0)) {
          console.log('React no ha renderizado después de 3 segundos, mostrando fallback');
          if (fallback) {
            fallback.style.display = 'block';
            loadCurrencyRates(); // Cargar las tasas de cambio
          }
        }
      }, 3000);
    </script>
  </body>
</html>
